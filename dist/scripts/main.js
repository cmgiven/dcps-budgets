!function(){"use strict";function r(t){return t-1+"-"+t.toString().substring(2)}var c,e,s,d=2021,h={enrollment:"Enrollment-Based Funds",specialty:"Specialty Funds",perpupilmin:"Per-Pupil Funding Minimum Funds",stabilization:"Stabilization Funds",sped:"Special Education Funds",ell:"English Language Learner Funds",atrisk:"At-Risk Funds",income:"Grant and ASP/ECR Funds",security:"Security Funds",other:"Non-General Education Funds"},u=d3.format(",.0f"),a=d3.format("04d");$(function(){d3.csv("data/data.csv",function(t){var e={name:t.SCHOOLNAME,year:+t.YEAR,code:a(t.SCHOOLCODE),ward:""===t.WARD?null:t.WARD,level:""===t.LEVEL?null:t.LEVEL,fortyForty:t.FORTYFORTY,budget:{},enrollment:{}};return e.budget[t.YEAR]=[{category:"enrollment",value:+t.AMT_ENROLLMENT},{category:"specialty",value:+t.AMT_SPECIALTY},{category:"perpupilmin",value:+t.AMT_PPFM},{category:"stabilization",value:+t.AMT_STABILIZATION},{category:"sped",value:+t.AMT_SPED},{category:"ell",value:+t.AMT_ELL},{category:"atrisk",value:+t.AMT_ATRISK},{category:"income",value:+t.AMT_TITLE+ +t.AMT_ASPECR},{category:"security",value:+t.AMT_SECURITY}],e.enrollment[t.YEAR]={total:""===t.TOTALENROLLMENT?null:+t.TOTALENROLLMENT,atRisk:""===t.ATRISKENROLLMENT?null:+t.ATRISKENROLLMENT},e},c.initialize)}),c={initialize:function(t){c.globals={comparison:1},$("#loading").fadeOut(),$("#main").fadeIn(),$("p.what a").click(function(){var t=$.attr(this,"href");return $("html, body").animate({scrollTop:$(t).offset().top},500),!1});var e=_.partition(_.reject(t,{level:"other"}),{year:d});function a(){"Bars"===c.globals.view?$("#legend").removeClass("hidden"):$("#legend").addClass("hidden"),"gened"===c.globals.category?($("#legend li").removeClass("hidden"),$("#legend .other-gened").removeClass("hidden"),$("#legend .gened-hidden").addClass("hidden")):"atrisk"===c.globals.category?($("#legend li").addClass("hidden"),$("#legend .atrisk").removeClass("hidden"),$("#legend .other-atrisk").removeClass("hidden")):($("#legend li").removeClass("hidden"),$("#legend .other").addClass("hidden"))}c.data=e[0],_.each(e[1],function(e){var t=_.find(c.data,function(t){return t.code===e.code});t&&(t.budget[e.year]=e.budget[e.year],t.enrollment[e.year]=e.enrollment[e.year])}),c.filterData({}),c.setCategory("gened"),c.loadView("Bars"),$(window).resize(function(){c.view.resize()}),a(),$("#views").change(function(t){c.loadView($(t.target).attr("value")),a()}),$("#filters").change(function(){var a={};$("#filters input:checked").each(function(){var t=$(this),e=t.attr("value");e&&(a[t.attr("name")]=e)}),c.filterData(a)}),$("#categories").change(function(t){c.setCategory($(t.target).attr("value")),a()}),$("#comparisons").change(function(t){c.setComparison($(t.target).attr("value"))})},filterData:function(e){c.globals.filter=e;var a=_.matches(e);_.each(c.data,function(t){t.filtered=!_.isEmpty(e)&&!a(t)}),c.view&&c.view.refresh()},setCategory:function(t){t=t||c.globals.category;function s(t,e){return t+e.value}var o="gened"===(c.globals.category=t)?["enrollment","specialty","perpupilmin","stabilization"]:"total"===t?["enrollment","specialty","perpupilmin","stabilization","sped","ell","atrisk","income","security"]:[t];_.each(c.data,function(r){r.selected={},_.each(r.budget,function(t,e){var a,l,n;a=_.partition(t,function(t){return _.includes(o,t.category)}),n=_.filter(t,function(t){return _.includes(o,t.category)&&"security"!==t.category}),(l={}).lines=a[0],l.total=_.reduce(l.lines,s,0),l.totalMinusSecurity=_.reduce(n,s,0),l.lines.push({category:"other",value:_.reduce(a[1],s,0)}),l.fullBudget=_.reduce(l.lines,s,0),r.selected[e]=l}),r.change=null,_.has(r.selected,d-c.globals.comparison)&&(r.change=r.selected[d].totalMinusSecurity/r.enrollment[d].total/(r.selected[d-c.globals.comparison].total/r.enrollment[d-c.globals.comparison].total)-1),r.enrchange=null,_.has(r.selected,d-c.globals.comparison)&&(r.enrchange=r.enrollment[d].total/r.enrollment[d-c.globals.comparison].total-1)}),c.view&&c.view.refresh()},setComparison:function(t){c.globals.comparison="one-year-ago"===t?1:"two-years-ago"===t?2:"three-years-ago"===t?3:"four-years-ago"===t?4:"five-years-ago"===t?5:6,$("#school-view").hide(),$("#school-view .previous-year span.year").text(r(d-c.globals.comparison)),c.setCategory()},loadView:function(t){c.globals.view=t,$("#exhibit").empty(),$("#school-view").hide(),c.view=new e[t](c.data)}},window.app=c,(e={Bars:function(t){var e,n=this;this.$el=$("#exhibit"),this.data=_.sortBy(t,function(t){return-(t.selected[d].fullBudget/t.enrollment[d].total)}),this.table=d3.select("#exhibit").append("table").attr("class","bar-chart").attr("summary","Schools by the funding per student"),(e=this.table.append("thead").append("tr")).append("th").attr("scope","col").attr("data-sort","name").text("School Name").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","enrollment").attr("class","descending").text(r(d)+" Enrollment").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","budget").attr("class","selected descending").text("Funds per Student").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","change").attr("class","descending").text("Change").append("span").attr("class","sort-arrow"),$("table.bar-chart th").click(function(){var a,t=$(this),l=t.data("sort");t.hasClass("selected")&&"name"!==l?t.toggleClass("descending"):($("table.bar-chart th").removeClass("selected"),t.addClass("selected")),a=t.hasClass("descending"),n.refresh(function(t){var e;switch(l){case"budget":e=t.selected[d].total/t.enrollment[d].total;break;case"enrollment":e=t.enrollment[d].total;break;default:e=t[l]}return a?-e:e})}),this.tbody=this.table.append("tbody"),this.removeSchoolViews=function(t){$(".bar-chart .school-view").slideUp({duration:t?0:400,complete:function(){$(this).parent().parent().remove()}})},this.sort=function(t){return-(t.selected[d].total/t.enrollment[d].total)},this.click=function(t){if(n.removeSchoolViews(),t.code&&t.code!==n.expandedRow){n.expandedRow=t.code;var e=$("<tr>").addClass("school-view-row"+($(this).hasClass("odd")?" odd":"")),a=$("<td>").attr("colspan",4).appendTo(e),l=$("#school-view").clone().removeAttr("id");s(d3.select(l[0]),t),l.find("button.close").click(function(){n.expandedRow=null,n.removeSchoolViews()}),l.appendTo(a),$(this).after(e),l.slideDown()}else n.expandedRow=null},this.refresh()}}).Bars.prototype.resize=function(){},e.Bars.prototype.refresh=function(t){this.removeSchoolViews(!0),this.sort=t||this.sort;var e=this.tbody.selectAll("tr.bar").data(_.sortBy(this.data,this.sort)),a=_.template('<td><%= name %></td><td class="<%= enrchange < 0 ? "negative" : "" %>"> <span class="amount"><%= enrollment[CURRENT_YEAR].total %></span> <%= " (" + (enrchange * 100).toFixed(1) + "%)" %></td><td><div class="wrapper"><div class="bar"><span class="year"><%= yearFormatter(CURRENT_YEAR) + ": " %></span><span class="label"><%= "$" + commasFormatter(selected[CURRENT_YEAR].total / enrollment[CURRENT_YEAR].total) %></span><% _.each(selected[CURRENT_YEAR].lines, function (line) { %><span class="rect <%= line.category %>" title="<%= prettyCategories[line.category] %>"style="width: <%= (line.value / enrollment[CURRENT_YEAR].total) / max * 100 %>%;"></span><% }); %></div><% if (selected[CURRENT_YEAR - app.globals.comparison]) { %><div class="bar previous-year"><span class="year"><%= yearFormatter(CURRENT_YEAR - app.globals.comparison) + ": " %></span><span class="label"><%= "$" + commasFormatter(selected[CURRENT_YEAR - app.globals.comparison].total / enrollment[CURRENT_YEAR - app.globals.comparison].total) %></span><% _.each(selected[CURRENT_YEAR - app.globals.comparison].lines, function (line) { %><span class="rect <%= line.category %>" title="<%= prettyCategories[line.category] %>"style="width: <%= (line.value / enrollment[CURRENT_YEAR - app.globals.comparison].total) / max * 100 %>%;"></span><% }); %></div><% } %></div></td><td class="<%= change < 0 ? "negative" : "" %>"><%= change ? (change * 100).toFixed(1) + "%" : "NA" %></td>',{imports:{commasFormatter:u,yearFormatter:r,CURRENT_YEAR:d,max:33247,prettyCategories:h}}),l=0;e.enter().append("tr").on("click",this.click),e.attr("class",function(t){return"bar school-"+t.code}).html(function(t){return a(t)}),e.classed("filtered",function(t){return t.filtered}).classed("odd",function(t){return t.filtered||(l+=1),l%2==1}),e.exit().remove()},e.Lines=function(t){var r=this,e={es:"Elementary",ms:"Middle",hs:"High",campus:"Education Campus"};this.margin={top:6,right:2,bottom:38,left:42},this.data=d3.nest().key(function(t){return t.level}).entries(_.reject(t,function(t){return null===t.level})),this.data=_.sortBy(this.data,function(t){return _.indexOf(["es","ms","hs","campus"],t.key)}),this.$el=$("#exhibit"),this.y=d3.scale.linear(),this.multiples=d3.select("#exhibit").selectAll(".multiple").data(this.data).enter().append("div").attr("class",function(t){return"multiple "+t.key}),this.multiples.append("span").attr("class","title").text(function(t){return e[t.key]}),this.tooltipName=this.multiples.append("span").attr("class","tooltip-name"),this.svg=this.multiples.append("svg").attr("class","slopegraph chart"),this.g=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.fg=this.g.append("g"),this.bg=this.g.append("g"),this.tooltipsLayer=this.g.append("g").attr("class","tooltips"),this.interactionLayer=this.g.append("g"),this.mouseover=function(t){r.fg.select(".line.school-"+t.code).classed("highlighted",!0);var e=d3.select(this.parentNode.parentNode).select(".tooltips"),a=d3.select(this.parentNode.parentNode.parentNode.parentNode).select(".tooltip-name"),l=e.append("g").attr("class","label").attr("transform","translate(30,"+(t.y1-8)+")"),n=e.append("g").attr("class","label").attr("transform","translate("+(r.width-30)+","+(t.y2-8)+")");a.text(t.name),l.append("rect").attr("x",-27).attr("y",-13).attr("width",55).attr("height",17).attr("rx",3).attr("ry",3),l.append("text").text("$"+u(t.selected[d-c.globals.comparison].total/t.enrollment[d-c.globals.comparison].total)).attr("text-anchor","middle"),n.append("rect").attr("x",-28).attr("y",-13).attr("width",55).attr("height",17).attr("rx",3).attr("ry",3),n.append("text").text("$"+u(t.selected[d].total/t.enrollment[d].total)).attr("text-anchor","middle")},this.mouseout=function(t){r.fg.select(".line.school-"+t.code).classed("highlighted",!1),r.tooltipsLayer.selectAll(".label").remove(),r.tooltipName.text("")},this.click=function(t){s(d3.select("#school-view"),t),$("#school-view").slideDown(),$("#school-view button.close").click(function(){$("#school-view").slideUp()})},this.resize()},e.Lines.prototype.resize=function(){this.width=this.$el.children().first().width()-this.margin.left-this.margin.right,this.height=400-this.margin.top-this.margin.bottom,this.pageWidth=this.$el.width(),this.svg.attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom),this.y.range([this.height,0]),this.refresh()},e.Lines.prototype.refresh=function(){var t,e,a,l,n=_.reduce(_(this.data).values().pluck("values").flatten().value(),function(t,e){var a=Math.max(e.selected[d].total/e.enrollment[d].total,_.get(e,["selected",d-c.globals.comparison,"total"],0)/_.get(e,["enrollment",d-c.globals.comparison,"total"],1));return t<a?2e3*Math.ceil(a/2e3):t},0),r=this;this.y.domain([0,n]),t=d3.svg.axis().scale(this.y).orient("left").tickSize(0).tickValues([0,n/2,n]).tickFormat(function(t){return"$"+u(t/1e3)+"K"}),e=d3.svg.axis().scale(this.y).orient("right").tickSize(0).tickFormat(""),this.bg.selectAll(".axis").remove(),this.bg.append("g").attr("class","axis").call(t).append("text").text(d-c.globals.comparison).attr("class","year").attr("x",5).attr("y",15),this.bg.append("g").attr("class","axis").attr("transform","translate("+this.width+",0)").call(e).append("text").text(d).attr("class","year").attr("text-anchor","end").attr("x",-5).attr("y",15),this.bg.selectAll(".tick text").style("text-anchor","middle").attr("x",-(this.margin.left+this.margin.right)/2),(a=this.fg.selectAll(".line").data(function(t){return _.reject(t.values,function(t){return!_.has(t.budget,d-c.globals.comparison)})},function(t){return t.code})).enter().append("line").attr("class",function(t){return"line school-"+t.code}).attr("x1",0).attr("x2",this.width),a.classed("filtered",function(t){return t.filtered}),a.transition().duration(400).attr("y1",function(t){return t.y1=r.y(t.selected[d-c.globals.comparison].total/t.enrollment[d-c.globals.comparison].total),t.y1}).attr("y2",function(t){return t.y2=r.y(t.selected[d].total/t.enrollment[d].total),t.y2}),a.exit().remove(),(l=this.interactionLayer.selectAll(".interaction-line").data(function(t){return _.reject(t.values,"filtered")||!_.has(school.budget,d-c.globals.comparison)})).enter().append("line").attr("class","interaction-line").attr("x1",0).attr("x2",this.width).on("mouseover",this.mouseover).on("mouseout",this.mouseout).on("click",this.click),l.attr("y1",function(t){return t.y1}).attr("y2",function(t){return t.y2}),l.exit().remove()},s=function(n,r){var t=n.selectAll("ul.field.budgetlines"),e=n.selectAll("div.chart.current-year"),a=n.selectAll("div.chart.previous-year"),l=d3.layout.pie().sort(null),s=d3.svg.arc().innerRadius(27).outerRadius(35);function o(t){return t||0===t?t:""}function i(t,e){t.selectAll("svg").remove();var a=t.append("svg").attr("width","70px").attr("height","70px").append("g");a.attr("transform","translate(35,35)").selectAll(".arc").data(l([0,1])).enter().append("path").attr("class","arc").attr("d",function(t){return this._current=t,s(t)}).data(l([e,1-e])).transition().duration(1e3*e).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return function(t){return s(e(t))}}),a.append("text").attr("class","amount").attr("y",5).style("text-anchor","middle").text("0%").transition().duration(1e3*e).tween("text",function(){if(!e&&0!==e)return function(){this.textContent=""};return function(t){this.textContent=(e*t*100).toFixed(0)+"%"}})}n.selectAll(".field.schoolname").text(r.name),r.enrollment[d-c.globals.comparison]?(n.selectAll(".field.previous-year.atriskcount").text(o(r.enrollment[d-c.globals.comparison].atRisk)),n.selectAll(".field.previous-year.enrollment").text(o(r.enrollment[d-c.globals.comparison].total)),i(a,r.enrollment[d-c.globals.comparison].atRisk/r.enrollment[d-c.globals.comparison].total)):(n.selectAll(".field.previous-year.atriskcount").text("0"),n.selectAll(".field.previous-year.enrollment").text("0"),a.selectAll("svg").remove()),n.selectAll(".field.current-year.atriskcount").text(o(r.enrollment[d].atRisk)),n.selectAll(".field.current-year.enrollment").text(o(r.enrollment[d].total)),i(e,r.enrollment[d].atRisk/r.enrollment[d].total),n.selectAll("a.learndc").attr("href","http://learndc.org/schoolprofiles/view?s="+r.code+"#overview"),t.selectAll("li").remove(),_.forEach({current:d,previous:d-c.globals.comparison},function(t,e){var a=n.selectAll("ul.field.budgetlines."+e+"-year"),l=r.budget[t];_.each(l,function(t){a.append("li").html('<span class="amount">$'+u(t.value)+"</span> "+h[t.category])})})}}();